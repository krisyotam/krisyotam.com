# ==============================================================================
# krisyotam.com.conf — Unified Site Configuration
# ==============================================================================
#
# --------------------------------------------------------------
#  Author   : Kris Yotam (aka. khr1st)
#  Contact  : krisyotam@protonmail.com
#  License  : GNU GPLv3
#  Updated  : 2026-01-14
# --------------------------------------------------------------
#
# nginx reverse proxy config for krisyotam.com
# - Replaces Traefik for full control
# - Handles clearnet, Tor hidden service, and /doc directory listing
# - SSL via Let's Encrypt + deSEC DNS challenge
# ==============================================================================


# ==============================================================
# Redirect: www.krisyotam.com → krisyotam.com
# ==============================================================

server {
    listen 80;
    listen 443 ssl http2;

    server_name www.krisyotam.com;

    ssl_certificate     /etc/letsencrypt/live/krisyotam.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/krisyotam.com/privkey.pem;

    return 301 https://krisyotam.com$request_uri;
}


# ==============================================================
# Redirect: Alternate domains → krisyotam.com
# COMMENTED OUT - Enable after DNS changes
# ==============================================================

# server {
#     listen 80;
#     listen 443 ssl http2;
#
#     server_name
#         krisyotam.net
#         www.krisyotam.net
#         kyotam.com
#         www.kyotam.com;
#
#     # Note: Will need separate certs or wildcard for these domains
#     ssl_certificate     /etc/letsencrypt/live/krisyotam.net/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/krisyotam.net/privkey.pem;
#
#     return 301 https://krisyotam.com$request_uri;
# }


# ==============================================================
# Primary Clearnet Server — krisyotam.com
# ==============================================================

server {
    listen 80;
    listen 443 ssl http2;

    server_name krisyotam.com;

    # --------------------------------------------------------------
    # TLS (Let's Encrypt via deSEC DNS challenge)
    # --------------------------------------------------------------
    ssl_certificate     /etc/letsencrypt/live/krisyotam.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/krisyotam.com/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # --------------------------------------------------------------
    # Logging
    # --------------------------------------------------------------
    access_log /var/log/nginx/krisyotam.access.log;
    error_log  /var/log/nginx/krisyotam.error.log warn;

    # --------------------------------------------------------------
    # /doc — Directory Listing (autoindex with custom theme)
    # Serves local files from /home/krisyotam/doc
    # --------------------------------------------------------------
    location /doc {
        alias /home/krisyotam/doc;

        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;

        # Inject custom theme CSS/JS
        sub_filter '</head>' '<link rel="stylesheet" href="/doc-theme/style.css"><script src="/doc-theme/autoindex.js"></script></head>';
        sub_filter_once on;
        sub_filter_types text/html;

        charset utf-8;

        # Allow directory browsing, serve files directly
        try_files $uri $uri/ =404;
    }

    # Theme assets for directory listing
    location /doc-theme/ {
        alias /home/krisyotam/doc-theme/;
    }

    # --------------------------------------------------------------
    # Main Site — Proxy to Next.js container
    # --------------------------------------------------------------
    location / {
        proxy_pass http://127.0.0.1:3080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}


# ==============================================================
# Tor Hidden Service — [onion address]
# ==============================================================

server {
    listen 127.0.0.1:8081;  # Tor forwards here
    server_name _;          # Accepts any hostname (onion)

    # Privacy headers
    add_header X-Robots-Tag "none" always;
    add_header Cache-Control "no-store" always;

    access_log off;
    error_log /var/log/nginx/krisyotam.tor.error.log warn;

    # /doc — Directory Listing (same as clearnet)
    location /doc {
        alias /home/krisyotam/doc;

        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;

        sub_filter '</head>' '<link rel="stylesheet" href="/doc-theme/style.css"><script src="/doc-theme/autoindex.js"></script></head>';
        sub_filter_once on;
        sub_filter_types text/html;

        charset utf-8;
        try_files $uri $uri/ =404;
    }

    location /doc-theme/ {
        alias /home/krisyotam/doc-theme/;
    }

    # Main Site — Proxy to Next.js
    location / {
        proxy_pass http://127.0.0.1:3080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}


# ==============================================================
# IPFS Host — krisyotam.eth (DISABLED)
# ==============================================================
# Uncomment when IPFS/ENS setup is ready
#
# server {
#     listen 80;
#     listen 443 ssl http2;
#
#     server_name krisyotam.eth;
#
#     ssl_certificate     /etc/letsencrypt/live/krisyotam.eth/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/krisyotam.eth/privkey.pem;
#
#     location / {
#         proxy_pass http://127.0.0.1:3080;
#         proxy_set_header Host $host;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     }
# }

# ==============================================================================
