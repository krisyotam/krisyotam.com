# ==============================================================================
# krisyotam.com.conf — Unified Site Configuration
# ==============================================================================
#
# --------------------------------------------------------------
#  Author   : Kris Yotam (aka. khr1st)
#  Contact  : krisyotam@protonmail.com
#  License  : GNU GPLv3
#  Date     : 2025-09-29
# --------------------------------------------------------------
#
#
# Read top to bottom.
# Let the sections explain themselves.
# ==============================================================================

# ==============================================================
# Clearnet Redirector — aliases → krisyotam.com
# ==============================================================

server {
    # ==============================================================
    # Redirect-Only Server — non-canonical clearnet domains
    # ==============================================================

    listen 80;
    listen 443 ssl http2;

    server_name
        www.krisyotam.com
        krisyotam.net
        www.krisyotam.net
        kyotam.com
        www.kyotam.com;

    # --------------------------------------------------------------
    # TLS
    # --------------------------------------------------------------
    ssl_certificate     /etc/ssl/krisyotam/fullchain.pem;
    ssl_certificate_key /etc/ssl/krisyotam/privkey.pem;

    # --------------------------------------------------------------
    # Canonical Redirect
    # --------------------------------------------------------------
    return 301 https://krisyotam.com$request_uri;
}


# ==============================================================
# Primary Clearnet Server — krisyotam.com
# ==============================================================

server {
    # ==============================================================
    # Canonical Host
    # ==============================================================

    listen 80;
    listen 443 ssl http2;

    server_name krisyotam.com;

    # --------------------------------------------------------------
    # TLS
    # --------------------------------------------------------------
    ssl_certificate     /etc/ssl/krisyotam/fullchain.pem;
    ssl_certificate_key /etc/ssl/krisyotam/privkey.pem;

    # --------------------------------------------------------------
    # Core Paths
    # --------------------------------------------------------------
    root /var/www/krisyotam;
    index index index.html index.htm;

    # --------------------------------------------------------------
    # Default Behavior
    # --------------------------------------------------------------
    charset utf-8;
    default_type text/html;

    limit_except GET {
        deny all;
    }

    # --------------------------------------------------------------
    # Logging
    # --------------------------------------------------------------
    access_log /var/log/nginx/krisyotam.access.log;
    error_log  /var/log/nginx/krisyotam.error.log warn;

    # --------------------------------------------------------------
    # Main Location
    # --------------------------------------------------------------
    location / {
        try_files $uri $uri/ /index;
    }

    # --------------------------------------------------------------
    # Error Handling
    # --------------------------------------------------------------
    error_page 404 /404;

    location = /404 {
        internal;
    }

    # --------------------------------------------------------------
    # Future:
    # redirect maps, markdown API, Lua fallbacks,
    # rewrite hell, crawler triage
    # --------------------------------------------------------------
}


# ==============================================================
# IPFS Host — krisyotam.eth (NO redirect)
# ==============================================================

server {
    listen 80;
    listen 443 ssl http2;

    server_name krisyotam.eth;

    ssl_certificate     /etc/ssl/krisyotam/eth/fullchain.pem;
    ssl_certificate_key /etc/ssl/krisyotam/eth/privkey.pem;

    root /var/www/krisyotam;
    index index index.html index.htm;

    charset utf-8;

    access_log /var/log/nginx/krisyotam.eth.access.log;
    error_log  /var/log/nginx/krisyotam.eth.error.log warn;

    location / {
        try_files $uri $uri/ /index;
    }
}


# ==============================================================
# Tor Hidden Service — krisyotam.onion
# ==============================================================

server {
    listen 127.0.0.1:8081;  # forwarded by tor
    server_name krisyotam.onion;

    root /var/www/krisyotam;
    index index index.html index.htm;

    charset utf-8;

    # Privacy defaults
    add_header X-Robots-Tag "none" always;
    add_header Cache-Control "no-store" always;

    access_log off;
    error_log /var/log/nginx/krisyotam.tor.error.log warn;

    location / {
        try_files $uri $uri/ /index;
    }
}
# ==============================================================================